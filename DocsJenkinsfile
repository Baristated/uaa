#!/usr/bin/env groovy

pipeline {
    agent {
        docker {
            image 'repo.ci.build.ge.com:8443/predix-security/uaa-ci-testing:0.0.8'
            label 'dind'
            args '-v /var/lib/docker/.gradle:/root/.gradle'
        }
    }
    parameters {
        string(name: 'APP_NAME', defaultValue: 'predix-uaa-api-release', description: 'Application name that will host UAA docs')
    }
    environment {
        COMPLIANCEENABLED = true
    }
    options {
        timestamps()
        skipDefaultCheckout()
        buildDiscarder(logRotator(artifactDaysToKeepStr: '1', artifactNumToKeepStr: '1', daysToKeepStr: '5', numToKeepStr: '10'))
    }
    stages {
        stage('Build Docs') {
            environment {
                APP_MEMORY = '64M'
                DEPLOYMENT_TARGET = 'https://api.system.aws-usw02-pr.ice.predix.io -u predix-platform-robot'
                CF_CREDENTIALS = credentials("CF_CREDENTIALS_VPC")
            }
            steps {
                dir('uaa') {
                    checkout scm
                }
                dir('uaa-cf-release') {
                    git changelog: false, credentialsId: 'github.build.ge.com', poll: false, url: 'https://github.build.ge.com/predix/uaa-cf-release.git', branch: 'feature/jenkinsfile'
                }
                sh '''#!/bin/bash -ex
                    source uaa-cf-release/config-local/set-env.sh
                    unset HTTPS_PROXY
                    unset HTTP_PROXY
                    unset http_proxy
                    unset https_proxy
                    unset GRADLE_OPTS
                    pushd uaa
                        export APP_VERSION=`grep 'version' gradle.properties | sed 's/version=//'`
                        ./gradlew clean generateDocs
                        cd uaa/build/docs
                        touch Staticfile
                        cf login -a $DEPLOYMENT_TARGET -u $CF_CREDENTIALS_USR -p $CF_CREDENTIALS_PSW -o predix-release -s predix-acs
                        cf push $APP_NAME -m $APP_MEMORY
                    popd
                '''
            }
        }
    }
}